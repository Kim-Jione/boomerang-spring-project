<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.bumerang.domain.performance.PerformanceDao">

    <select id="findById"
            resultType="com.example.bumerang.domain.performance.Performance">
        SELECT * FROM performance WHERE pf_id=#{pfId} AND pf_status  != 'deleted'
    </select>

    <select id="findAll"
            resultType="com.example.bumerang.domain.performance.Performance">
        SELECT *
        FROM performance
        WHERE pf_status  != 'deleted'
    </select>

    <insert id="insert">
        INSERT INTO performance (pf_title, pf_content, pf_agerating, pf_start_date, pf_deadline, pf_bookingmethod, pf_production, pf_location, pf_runningtime, pf_price, pf_genre, pf_thumbnail, user_id)
        VALUES
        (#{pfTitle}, #{pfContent}, #{pfAgerating}, #{pfStartDate}, #{pfDeadline}, #{pfBookingmethod}, #{pfProduction}, #{pfLocation}, #{pfRunningtime}, #{pfPrice}, #{pfGenre}, #{pfThumbnail}, #{userId})
    </insert>

    <update id="update">
        UPDATE performance
        SET
        pf_title = #{pfTitle},
        pf_content = #{pfContent},
        pf_agerating = #{pfAgerating},
        pf_start_date = #{pfStartDate},
        pf_deadline = #{pfDeadline},
        pf_bookingmethod = #{pfBookingmethod},
        pf_production = #{pfProduction},
        pf_location = #{pfLocation},
        pf_runningtime = #{pfRunningtime},
        pf_price = #{pfPrice},
        pf_genre = #{pfGenre},
        pf_thumbnail = #{pfThumbnail}
        WHERE
        pf_id = #{pfId}
        AND user_id = #{userId}
        AND pf_status  != 'deleted'
    </update>

    <delete id="delete">
        UPDATE performance
        SET
        pf_status = 'deleted'
        WHERE pf_id = #{pfId}
    </delete>

    <update id="dead">
        UPDATE performance
        SET
        pf_status = 'dead'
        WHERE
        pf_id = #{pfId}
        AND user_id = #{userId}
    </update>

    <select id="findAllPf"
            resultType="com.example.bumerang.web.dto.response.performance.PfListDto">
        SELECT  p.pf_title, p.pf_location,
        CASE WHEN p.pf_price = 0 THEN FALSE
        ELSE TRUE END AS isPrice,
        p.pf_start_date, p.pf_deadline, p.pf_thumbnail,
        COALESCE(v.view_count, 0) AS view_count
        FROM performance p
        LEFT JOIN
        (SELECT pf_id, COUNT(view_id) AS view_count
        FROM VIEW
        WHERE pf_id IS NOT NULL
        GROUP BY pf_id) v
        ON p.pf_id = v.pf_id
        WHERE pf_status != 'deleted'
    </select>

    <select id="findAllBestPf"
            resultType="com.example.bumerang.web.dto.response.performance.PfListDto">
        SELECT p.pf_title, p.pf_location,
        CASE WHEN p.pf_price = 0 THEN FALSE ELSE TRUE END AS isPrice,
        p.pf_start_date, p.pf_deadline, p.pf_thumbnail,
        COALESCE(v.view_count, 0) AS viewCount
        FROM performance p
        LEFT JOIN (
            SELECT pf_id, COUNT(*) AS view_count
            FROM view
            GROUP BY pf_id
        ) v ON p.pf_id = v.pf_id
        WHERE p.pf_status != 'deleted'
        ORDER BY COALESCE(viewCount, 0) DESC
        LIMIT 6
    </select>

    <select id="findByRecent"
            resultType="com.example.bumerang.web.dto.response.performance.PfRespDto">
        SELECT *
        FROM performance p
        WHERE p.pf_id=LAST_INSERT_ID()
    </select>

    <select id="findByPf" resultType="com.example.bumerang.web.dto.response.performance.DetailFormDto">
        SELECT *,
        (SELECT COUNT(*) FROM likey WHERE pf_id = #{pfId}) as likeyCount,
        (SELECT COUNT(*) FROM view WHERE pf_id = #{pfId}) as viewCount
        FROM performance p
        LEFT JOIN user u
        ON p.user_id = u.user_id
        WHERE p.pf_id = #{pfId}
        AND p.pf_status != 'deleted'
    </select>

</mapper>